<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kotweb - Home</title>
    <style>
        :root {
            --bg: #000000;
            --orange: #ff7a00;
            --white: #ffffff;
            --muted: #bfbfbf;
            --error: #ff3333;
            --success: #00cc66;
            --glass: rgba(255,255,255,0.03);
            --chat-received: #1a1a1a;
            --chat-sent: #262626;
            font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            background: var(--bg);
            color: var(--white);
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header Styles */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: rgba(0, 0, 0, 0.8);
            border-bottom: 1px solid rgba(255, 255, 255, 0.06);
        }

        .system-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .system-indicator {
            padding: 6px 10px;
            background: var(--orange);
            color: #000;
            font-weight: 700;
            font-size: 12px;
        }

        .current-system {
            font-size: 14px;
            color: var(--muted);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .username {
            font-size: 14px;
            color: var(--muted);
        }

        .header-icons {
            display: flex;
            gap: 12px;
        }

        .icon-btn {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.06);
            color: var(--white);
            cursor: pointer;
        }

        .icon-btn:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        /* Main Chat Area */
        main {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        /* Message Styles */
        .message {
            max-width: 80%;
            padding: 12px;
            position: relative;
        }

        .message.received {
            align-self: flex-start;
            background: var(--chat-received);
            border-left: 3px solid var(--orange);
        }

        .message.sent {
            align-self: flex-end;
            background: var(--chat-sent);
            border-right: 3px solid var(--orange);
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
        }

        .message-sender {
            font-weight: 700;
            font-size: 14px;
        }

        .message-time {
            font-size: 12px;
            color: var(--muted);
        }

        .message-content {
            font-size: 15px;
            line-height: 1.4;
        }

        .message-image {
            max-width: 100%;
            margin-top: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .violation {
            filter: blur(5px);
            color: var(--error);
            position: relative;
        }

        .violation-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: var(--error);
            font-weight: bold;
            z-index: 10;
        }

        .message-actions {
            display: flex;
            gap: 10px;
            margin-top: 8px;
            font-size: 12px;
        }

        .action-btn {
            color: var(--muted);
            cursor: pointer;
        }

        .action-btn:hover {
            color: var(--white);
        }

        /* Input Area */
        .input-area {
            padding: 16px;
            border-top: 1px solid rgba(255, 255, 255, 0.06);
            background: rgba(0, 0, 0, 0.5);
        }

        .message-input-container {
            display: flex;
            gap: 10px;
        }

        .message-input {
            flex: 1;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.06);
            color: var(--white);
            resize: none;
            min-height: 44px;
            max-height: 120px;
            font-family: inherit;
            font-size: 15px;
            border-radius: 22px;
        }

        .message-input:focus {
            outline: none;
            border-color: var(--orange);
        }

        .send-btn {
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--orange);
            color: #000;
            border: none;
            cursor: pointer;
            border-radius: 50%;
        }

        .upload-btn {
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.06);
            color: var(--white);
            cursor: pointer;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 16px;
            background: var(--success);
            color: #000;
            font-weight: 700;
            z-index: 1000;
            display: none;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .username {
                display: none;
            }
            
            .message {
                max-width: 90%;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="system-info">
            <div class="system-indicator">SYSTEM</div>
            <div class="current-system" id="current-system">In Gasabo > Senior 4</div>
        </div>
        <div class="header-right">
            <div class="username" id="username-display">john_doe</div>
            <div class="header-icons">
                <button class="icon-btn" onclick="openPage('status.html')" title="Status">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z" stroke="currentColor" stroke-width="2"/>
                        <path d="M12 6V12L16 14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                </button>
                <button class="icon-btn" onclick="openPage('search.html')" title="Search">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M21 21L15 15M17 10C17 13.866 13.866 17 10 17C6.13401 17 3 13.866 3 10C3 6.13401 6.13401 3 10 3C13.866 3 17 6.13401 17 10Z" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                </button>
                <button class="icon-btn" onclick="openPage('terms.html')" title="Read">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 6.25278V19.2528M12 6.25278C10.8321 5.47686 9.24649 5 7.5 5C5.75351 5 4.16789 5.47686 3 6.25278V19.2528C4.16789 18.4769 5.75351 18 7.5 18C9.24649 18 10.8321 18.4769 12 19.2528M12 6.25278C13.1679 5.47686 14.7535 5 16.5 5C18.2465 5 19.8321 5.47686 21 6.25278V19.2528C19.8321 18.4769 18.2465 18 16.5 18C14.7535 18 13.1679 18.4769 12 19.2528" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
                <button class="icon-btn" onclick="openPage('settings.html')" title="Settings">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 15C13.6569 15 15 13.6569 15 12C15 10.3431 13.6569 9 12 9C10.3431 9 9 10.3431 9 12C9 13.6569 10.3431 15 12 15Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M19.4 15C19.2669 15.3 19.2 15.6 19.2 16.2C19.2 17.1 19.8 18 20.7 18.3C21.6 18.6 22.2 19.5 21.9 20.4C21.6 21.3 20.7 21.9 19.8 21.6C18.9 21.3 18.3 20.4 18.6 19.5C18.7 19.2 18.8 18.9 19.1 18.6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M2.1 20.4C2.4 19.5 3 18.6 3.9 18.3C4.8 18 5.4 17.1 5.1 16.2C4.8 15.3 3.9 14.7 3 15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M5.1 7.8C5.4 6.9 6 6 6.9 5.7C7.8 5.4 8.4 4.5 8.1 3.6C7.8 2.7 6.9 2.1 6 2.4C5.1 2.7 4.5 3.6 4.8 4.5C4.9 4.8 5 5.1 5.3 5.4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M19.4 9C19.1 8.1 18.5 7.2 17.6 6.9C16.7 6.6 16.1 5.7 16.4 4.8C16.7 3.9 17.6 3.3 18.5 3.6C19.4 3.9 20 4.8 19.7 5.7C19.6 6 19.5 6.3 19.2 6.6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
                <button class="icon-btn" id="menu-btn" title="Menu">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M4 6H20M4 12H20M4 18H20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
            </div>
        </div>
    </header>

    <main>
        <div class="chat-container" id="chat-container">
            <!-- Messages will be dynamically inserted here -->
            <div class="message received">
                <div class="message-header">
                    <span class="message-sender">System</span>
                    <span class="message-time">Today, 10:30 AM</span>
                </div>
                <div class="message-content">
                    Welcome to Kotweb! This is the public chat for Senior 4 students in Gasabo district.
                </div>
            </div>
            
            <div class="message sent">
                <div class="message-header">
                    <span class="message-sender">You</span>
                    <span class="message-time">Today, 10:32 AM</span>
                </div>
                <div class="message-content">
                    Hello everyone! Glad to be here.
                </div>
                <div class="message-actions">
                    <span class="action-btn">Edit</span>
                    <span class="action-btn">Delete</span>
                </div>
            </div>
            
            <div class="message received">
                <div class="message-header">
                    <span class="message-sender">Marie</span>
                    <span class="message-time">Today, 10:35 AM</span>
                </div>
                <div class="message-content">
                    Does anyone have notes from yesterday's math class?
                </div>
            </div>
            
            <div class="message received">
                <div class="message-header">
                    <span class="message-sender">Jean</span>
                    <span class="message-time">Today, 10:40 AM</span>
                </div>
                <div class="message-content violation">
                    <span class="violation-text">Violation</span>
                    This message contains inappropriate content and has been hidden.
                </div>
            </div>
        </div>
    </main>

    <div class="input-area">
        <div class="message-input-container">
            <textarea class="message-input" id="message-input" placeholder="Type your message..." rows="1"></textarea>
            <button class="upload-btn" id="upload-btn" title="Upload image">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M4 16L4 17C4 18.6569 5.34315 20 7 20L17 20C18.6569 20 20 18.6569 20 17L20 16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    <path d="M12 4L12 16M12 4L8 8M12 4L16 8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>
            <button class="send-btn" id="send-btn">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M22 2L11 13M22 2L15 22L11 13L2 9L22 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>
        </div>
    </div>

    <div class="notification" id="notification">
        New message received
    </div>

    <audio id="message-sound" preload="auto">
        <source src="message.mp3" type="audio/mpeg">
    </audio>

    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";
        import { getMessaging, onMessage } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-messaging.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyB1FG7OAGIgJqg3bmpStVTpi0RqpI_DctE",
            authDomain: "music-app-718f4.firebaseapp.com",
            databaseURL: "https://music-app-718f4-default-rtdb.firebaseio.com",
            projectId: "music-app-718f4",
            storageBucket: "music-app-718f4.firebasestorage.app",
            messagingSenderId: "91683197015",
            appId: "1:91683197015:web:92899ecb0c913dc0a95312",
            measurementId: "G-MQLRPLZZFF"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);
        // const messaging = getMessaging(app);

        // DOM elements
        const chatContainer = document.getElementById('chat-container');
        const messageInput = document.getElementById('message-input');
        const sendBtn = document.getElementById('send-btn');
        const uploadBtn = document.getElementById('upload-btn');
        const usernameDisplay = document.getElementById('username-display');
        const currentSystem = document.getElementById('current-system');
        const notification = document.getElementById('notification');
        const messageSound = document.getElementById('message-sound');

        // User data and current chat info
        let userData = null;
        let currentChatPath = null;

        // Inappropriate words filter
        const inappropriateWords = ['fuck', 'shit', 'asshole', 'bitch', 'cunt', 'nigger', 'retard', 'hacking', 'hack', 'cheat', 'crack'];

        // Check if user is logged in
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // User is signed in
                try {
                    // Get user data from localStorage
                    const userDataStr = localStorage.getItem('kotweb_user');
                    if (userDataStr) {
                        userData = JSON.parse(userDataStr);
                        usernameDisplay.textContent = userData.username;
                        
                        // Set up the chat based on user's district and class
                        setupChat(userData.district, userData.class);
                    } else {
                        // Redirect to login if no user data
                        window.location.href = 'index.html';
                    }
                } catch (error) {
                    console.error("Error getting user data:", error);
                    window.location.href = 'index.html';
                }
            } else {
                // User is signed out, redirect to login
                window.location.href = 'index.html';
            }
        });

        // Set up the chat based on district and class
        function setupChat(district, studentClass) {
            // Update the current system display
            currentSystem.textContent = `In ${district} > ${studentClass}`;
            
            // Set the chat path: Rwanda > Class > District
            currentChatPath = `Rwanda/${studentClass}/${district}`;
            
            // Load existing messages
            loadMessages();
        }

        // Load messages from Firestore
        function loadMessages() {
            const messagesRef = collection(db, currentChatPath);
            const q = query(messagesRef, orderBy('timestamp', 'asc'));
            
            onSnapshot(q, (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    if (change.type === 'added') {
                        const message = change.doc.data();
                        addMessageToChat(
                            message.id,
                            message.senderId,
                            message.senderName,
                            message.text,
                            message.imageUrl,
                            message.timestamp.toDate(),
                            message.senderId === auth.currentUser.uid
                        );
                        
                        // Play sound if message is from another user
                        if (message.senderId !== auth.currentUser.uid) {
                            playMessageSound();
                            showNotification(`New message from ${message.senderName}`);
                        }
                    }
                });
                
                // Scroll to bottom
                chatContainer.scrollTop = chatContainer.scrollHeight;
            });
        }

        // Add message to chat UI
        function addMessageToChat(id, senderId, senderName, text, imageUrl, timestamp, isSent) {
            const messageEl = document.createElement('div');
            messageEl.classList.add('message');
            messageEl.classList.add(isSent ? 'sent' : 'received');
            messageEl.dataset.id = id;
            
            // Format time
            const timeString = formatTime(timestamp);
            
            // Check for inappropriate content
            const hasInappropriateContent = checkForInappropriateContent(text);
            
            messageEl.innerHTML = `
                <div class="message-header">
                    <span class="message-sender">${isSent ? 'You' : senderName}</span>
                    <span class="message-time">${timeString}</span>
                </div>
                <div class="message-content ${hasInappropriateContent ? 'violation' : ''}">
                    ${hasInappropriateContent ? '<span class="violation-text">Violation</span>' : ''}
                    ${text}
                    ${imageUrl ? `<img src="${imageUrl}" class="message-image" alt="Sent image">` : ''}
                </div>
                ${isSent ? `
                <div class="message-actions">
                    <span class="action-btn" onclick="editMessage('${id}')">Edit</span>
                    <span class="action-btn" onclick="deleteMessage('${id}')">Delete</span>
                </div>
                ` : ''}
            `;
            
            chatContainer.appendChild(messageEl);
            
            // Scroll to bottom
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // Check for inappropriate content
        function checkForInappropriateContent(text) {
            const lowerText = text.toLowerCase();
            return inappropriateWords.some(word => lowerText.includes(word));
        }

        // Format time for display
        function formatTime(date) {
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const messageDate = new Date(date.getFullYear(), date.getMonth(), date.getDate());
            
            const diffTime = Math.abs(now - date);
            const diffMinutes = Math.floor(diffTime / (1000 * 60));
            const diffHours = Math.floor(diffTime / (1000 * 60 * 60));
            
            if (diffMinutes < 1) {
                return 'Just now';
            } else if (diffMinutes < 60) {
                return `${diffMinutes} min ago`;
            } else if (diffHours < 24 && messageDate.getTime() === today.getTime()) {
                return `Today, ${date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`;
            } else if (diffHours < 48) {
                return `Yesterday, ${date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`;
            } else {
                return `${date.toLocaleDateString()}, ${date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`;
            }
        }

        // Send message
        async function sendMessage() {
            const text = messageInput.value.trim();
            if (!text && !currentImage) return;
            
            try {
                let imageUrl = null;
                
                // Upload image if exists
                if (currentImage) {
                    const storageRef = ref(storage, `chat-images/${Date.now()}_${currentImage.name}`);
                    await uploadBytes(storageRef, currentImage);
                    imageUrl = await getDownloadURL(storageRef);
                    currentImage = null;
                }
                
                // Add message to Firestore
                await addDoc(collection(db, currentChatPath), {
                    text: text,
                    imageUrl: imageUrl,
                    senderId: auth.currentUser.uid,
                    senderName: userData.username,
                    timestamp: serverTimestamp()
                });
                
                // Clear input
                messageInput.value = '';
                messageInput.style.height = 'auto';
            } catch (error) {
                console.error("Error sending message:", error);
                alert("Failed to send message. Please try again.");
            }
        }

        // Edit message
        async function editMessage(messageId) {
            const newText = prompt("Edit your message:", "");
            if (newText !== null) {
                try {
                    const messageRef = doc(db, currentChatPath, messageId);
                    await updateDoc(messageRef, {
                        text: newText,
                        edited: true
                    });
                } catch (error) {
                    console.error("Error editing message:", error);
                }
            }
        }

        // Delete message
        async function deleteMessage(messageId) {
            if (confirm("Are you sure you want to delete this message?")) {
                try {
                    const messageRef = doc(db, currentChatPath, messageId);
                    await deleteDoc(messageRef);
                } catch (error) {
                    console.error("Error deleting message:", error);
                }
            }
        }

        // Play message sound
        function playMessageSound() {
            messageSound.currentTime = 0;
            messageSound.play().catch(error => {
                console.log("Audio play failed:", error);
            });
        }

        // Show notification
        function showNotification(text) {
            notification.textContent = text;
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }

        // Auto-resize textarea
        messageInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
        });

        // Send message on Enter key (but allow Shift+Enter for new line)
        messageInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // Send button click
        sendBtn.addEventListener('click', sendMessage);

        // Image upload
        let currentImage = null;
        uploadBtn.addEventListener('click', function() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    currentImage = file;
                    showNotification("Image selected. Press send to share.");
                }
            };
            
            input.click();
        });

        // Open other pages
        window.openPage = function(page) {
            window.location.href = page;
        };

        // Make functions available globally for HTML onclick handlers
        window.editMessage = editMessage;
        window.deleteMessage = deleteMessage;

        // Listen for push notifications (requires proper setup)
        /*
        onMessage(messaging, (payload) => {
            console.log('Message received', payload);
            playMessageSound();
            showNotification(payload.notification.title);
        });
        */
    </script>
</body>
</html>
