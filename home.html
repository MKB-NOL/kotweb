<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kotweb - Home</title>
  <style>
    :root {
      --bg: #000000;
      --orange: #ff7a00;
      --white: #ffffff;
      --muted: #bfbfbf;
      --error: #ff3333;
      --success: #33ff33;
      --glass: rgba(255,255,255,0.03);
      --dropdown-bg: #1a1a1a;
      --chat-bg: #0a0a0a;
      --received-msg: #1a1a1a;
      --sent-msg: #2a1a00;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; background: var(--bg); color: var(--white); }

    /* Header styling */
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      background: rgba(0,0,0,0.8);
      border-bottom: 1px solid rgba(255,255,255,0.06);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .logo { font-weight: 700; font-size: 20px; color: var(--orange); }

    .header-icons {
      display: flex;
      gap: 16px;
      align-items: center;
    }

    .icon-btn {
      background: none;
      border: none;
      color: var(--white);
      cursor: pointer;
      font-size: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 36px;
      height: 36px;
    }

    .icon-btn:hover { color: var(--orange); }

    .current-system {
      padding: 6px 12px;
      background: rgba(255,122,0,0.1);
      border: 1px solid rgba(255,122,0,0.3);
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .username-display {
      font-size: 14px;
      color: var(--muted);
      margin-right: 10px;
    }

    /* Main chat area */
    main {
      display: flex;
      height: calc(100vh - 120px);
    }

    .sidebar {
      width: 240px;
      border-right: 1px solid rgba(255,255,255,0.06);
      padding: 16px;
      overflow-y: auto;
      background: rgba(0,0,0,0.5);
    }

    .sidebar-section {
      margin-bottom: 24px;
    }

    .sidebar-title {
      font-size: 14px;
      color: var(--orange);
      margin-bottom: 12px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .chat-room {
      padding: 10px;
      margin-bottom: 8px;
      cursor: pointer;
      border: 1px solid transparent;
      font-size: 14px;
    }

    .chat-room:hover {
      background: rgba(255,255,255,0.05);
    }

    .chat-room.active {
      background: rgba(255,122,0,0.1);
      border-color: rgba(255,122,0,0.3);
    }

    .chat-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: var(--chat-bg);
    }

    .chat-header {
      padding: 12px 16px;
      border-bottom: 1px solid rgba(255,255,255,0.06);
      font-weight: 600;
      background: rgba(0,0,0,0.3);
    }

    .messages-container {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .message {
      max-width: 70%;
      padding: 12px;
      position: relative;
    }

    .message.received {
      align-self: flex-start;
      background: var(--received-msg);
      border-left: 3px solid var(--orange);
    }

    .message.sent {
      align-self: flex-end;
      background: var(--sent-msg);
      border-right: 3px solid var(--orange);
    }

    .message-username {
      font-weight: 600;
      font-size: 14px;
      margin-bottom: 4px;
      color: var(--orange);
    }

    .message-content {
      margin-bottom: 4px;
      word-break: break-word;
    }

    .message-time {
      font-size: 11px;
      color: var(--muted);
      text-align: right;
    }

    .message.violation .message-content {
      filter: blur(5px);
      color: var(--error);
      position: relative;
    }

    .message.violation .message-content::after {
      content: "Violation";
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: var(--error);
      font-weight: bold;
      filter: none;
    }

    .message-actions {
      position: absolute;
      top: 8px;
      right: 8px;
      display: none;
      gap: 8px;
    }

    .message:hover .message-actions {
      display: flex;
    }

    .message-action {
      background: rgba(0,0,0,0.7);
      border: none;
      color: var(--white);
      width: 24px;
      height: 24px;
      border-radius: 0;
      cursor: pointer;
      font-size: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .message-action:hover {
      background: var(--orange);
      color: black;
    }

    .input-area {
      padding: 16px;
      border-top: 1px solid rgba(255,255,255,0.06);
      background: rgba(0,0,0,0.3);
    }

    .message-input-container {
      display: flex;
      gap: 12px;
    }

    .message-input {
      flex: 1;
      padding: 12px;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      color: var(--white);
      outline: none;
      resize: none;
      min-height: 44px;
      max-height: 120px;
      border-radius: 22px;
    }

    .message-input:focus {
      border-color: var(--orange);
    }

    .send-btn, .upload-btn {
      background: var(--orange);
      color: black;
      border: none;
      width: 44px;
      height: 44px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }

    .upload-btn {
      background: rgba(255,255,255,0.1);
      color: var(--white);
    }

    .upload-btn:hover {
      background: rgba(255,255,255,0.2);
    }

    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 12px 16px;
      background: var(--orange);
      color: black;
      border-radius: 0;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      z-index: 1000;
      display: none;
    }

    /* Responsive design */
    @media (max-width: 768px) {
      .sidebar {
        width: 80px;
        padding: 10px;
      }
      
      .sidebar-title, .chat-room-name {
        display: none;
      }
      
      .chat-room {
        text-align: center;
        font-size: 20px;
        padding: 12px 0;
      }
      
      .message {
        max-width: 85%;
      }
    }

    /* Loading spinner */
    .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,.3);
      border-top: 3px solid var(--orange);
      animation: spin 1s linear infinite;
      border-radius: 50%;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <header>
    <div class="logo">KOTWEB</div>
    <div class="current-system">
      <span id="system-icon">üåê</span>
      <span id="current-system-text">In District</span>
    </div>
    <div class="header-icons">
      <span class="username-display" id="username-display">@username</span>
      <button class="icon-btn" title="Status" onclick="openPage('status.html')">üìä</button>
      <button class="icon-btn" title="Search" onclick="openPage('search.html')">üîç</button>
      <button class="icon-btn" title="Read" onclick="openPage('terms.html')">üìñ</button>
      <button class="icon-btn" title="Settings" onclick="openPage('settings.html')">‚öôÔ∏è</button>
      <button class="icon-btn" title="Menu" id="menu-btn">‚ò∞</button>
    </div>
  </header>

  <main>
    <aside class="sidebar">
      <div class="sidebar-section">
        <div class="sidebar-title">Rwanda Public</div>
        <div class="chat-room active" data-room="rwanda">
          <div class="chat-room-name">Rwanda Public</div>
        </div>
      </div>

      <div class="sidebar-section">
        <div class="sidebar-title">Classes</div>
        <div class="chat-room" data-room="senior1">
          <div class="chat-room-name">Senior 1</div>
        </div>
        <div class="chat-room" data-room="senior2">
          <div class="chat-room-name">Senior 2</div>
        </div>
        <div class="chat-room" data-room="senior3">
          <div class="chat-room-name">Senior 3</div>
        </div>
        <div class="chat-room" data-room="senior4">
          <div class="chat-room-name">Senior 4</div>
        </div>
        <div class="chat-room" data-room="senior5">
          <div class="chat-room-name">Senior 5</div>
        </div>
        <div class="chat-room" data-room="senior6">
          <div class="chat-room-name">Senior 6</div>
        </div>
      </div>

      <div class="sidebar-section">
        <div class="sidebar-title">Districts</div>
        <div class="chat-room" data-room="gasabo">
          <div class="chat-room-name">Gasabo</div>
        </div>
        <div class="chat-room" data-room="kicukiro">
          <div class="chat-room-name">Kicukiro</div>
        </div>
        <div class="chat-room" data-room="nyarugenge">
          <div class="chat-room-name">Nyarugenge</div>
        </div>
        <!-- More districts would be loaded dynamically -->
      </div>
    </aside>

    <section class="chat-container">
      <div class="chat-header" id="active-chat-header">
        Rwanda Public Chat
      </div>
      
      <div class="messages-container" id="messages-container">
        <!-- Messages will be loaded here -->
        <div class="message received">
          <div class="message-username">@john_doe</div>
          <div class="message-content">Hello everyone! Welcome to Kotweb üëã</div>
          <div class="message-time">Today, 10:30 AM</div>
          <div class="message-actions">
            <button class="message-action" title="Reply">‚Ü©</button>
          </div>
        </div>
        
        <div class="message sent">
          <div class="message-username">@you</div>
          <div class="message-content">Hi John! Glad to be here. This platform looks amazing!</div>
          <div class="message-time">Today, 10:32 AM</div>
          <div class="message-actions">
            <button class="message-action" title="Edit">‚úèÔ∏è</button>
            <button class="message-action" title="Delete">üóëÔ∏è</button>
          </div>
        </div>
        
        <div class="message received violation">
          <div class="message-username">@bad_user</div>
          <div class="message-content">This is an inappropriate message that contains blocked words</div>
          <div class="message-time">Today, 10:33 AM</div>
          <div class="message-actions">
            <button class="message-action" title="Report">‚ö†Ô∏è</button>
          </div>
        </div>
      </div>
      
      <div class="input-area">
        <div class="message-input-container">
          <textarea 
            class="message-input" 
            id="message-input" 
            placeholder="Type your message..." 
            rows="1"
          ></textarea>
          <input type="file" id="image-upload" accept="image/*" style="display: none;">
          <button class="upload-btn" id="upload-trigger" title="Upload image">üì∑</button>
          <button class="send-btn" id="send-button" title="Send message">‚û§</button>
        </div>
      </div>
    </section>
  </main>

  <div class="notification" id="notification">
    New message received
  </div>

  <audio id="message-sound" preload="auto">
    <source src="message.mp3" type="audio/mpeg">
  </audio>

  <!-- Firebase SDK -->
  <script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-analytics.js";
    import { 
      getAuth, 
      onAuthStateChanged,
      signOut 
    } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
    import { 
      getFirestore, 
      collection, 
      addDoc, 
      query, 
      where, 
      orderBy, 
      onSnapshot,
      updateDoc,
      deleteDoc,
      doc,
      serverTimestamp,
      getDocs
    } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";
    import { getMessaging, onMessage } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-messaging.js";

    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyAsfXkzcFVmsQLWGF_WqCPQWn7SRqkcvK8",
      authDomain: "kotweb-dd995.firebaseapp.com",
      projectId: "kotweb-dd995",
      storageBucket: "kotweb-dd995.firebasestorage.app",
      messagingSenderId: "534760591484",
      appId: "1:534760591484:web:1c90379da7852ddec2f9f9",
      measurementId: "G-9ZH53YSQZT"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const messaging = getMessaging(app);

    // Global variables
    let currentUser = null;
    let currentChatRoom = 'rwanda';
    let currentUserData = null;

    // Inappropriate words filter
    const inappropriateWords = ['fuck', 'shit', 'asshole', 'bitch', 'cunt', 'nigger', 'retard', 'fag', 'hack', 'hacking', 'cheat', 'cheating'];

    // DOM elements
    const messagesContainer = document.getElementById('messages-container');
    const messageInput = document.getElementById('message-input');
    const sendButton = document.getElementById('send-button');
    const uploadTrigger = document.getElementById('upload-trigger');
    const imageUpload = document.getElementById('image-upload');
    const usernameDisplay = document.getElementById('username-display');
    const activeChatHeader = document.getElementById('active-chat-header');
    const notification = document.getElementById('notification');
    const messageSound = document.getElementById('message-sound');
    const currentSystemText = document.getElementById('current-system-text');
    const systemIcon = document.getElementById('system-icon');

    // Check authentication state
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        currentUser = user;
        usernameDisplay.textContent = `@${user.displayName || 'user'}`;
        
        // Get user data from Firestore
        const usersRef = collection(db, "users");
        const q = query(usersRef, where("uid", "==", user.uid));
        const querySnapshot = await getDocs(q);
        
        if (!querySnapshot.empty) {
          currentUserData = querySnapshot.docs[0].data();
          loadChatRooms();
          loadMessages(currentChatRoom);
        } else {
          console.error("User data not found");
          signOut(auth);
        }
      } else {
        // Redirect to login if not authenticated
        window.location.href = 'login.html';
      }
    });

    // Load chat rooms based on user data
    function loadChatRooms() {
      if (!currentUserData) return;
      
      // Enable class-specific rooms based on user's class
      const userClass = currentUserData.class;
      document.querySelectorAll('.chat-room[data-room]').forEach(room => {
        const roomName = room.dataset.room;
        
        if (roomName.startsWith('senior')) {
          // Only enable the room for the user's class
          if (roomName === userClass.toLowerCase().replace(' ', '')) {
            room.style.opacity = '1';
            room.style.cursor = 'pointer';
          } else {
            room.style.opacity = '0.5';
            room.style.cursor = 'not-allowed';
          }
        }
        
        // Enable district rooms
        if (roomName === currentUserData.district.toLowerCase()) {
          room.style.opacity = '1';
          room.style.cursor = 'pointer';
        }
      });
    }

    // Load messages for a specific chat room
    function loadMessages(room) {
      // Clear current messages
      messagesContainer.innerHTML = '';
      
      // Update active room
      document.querySelectorAll('.chat-room').forEach(r => {
        r.classList.remove('active');
      });
      document.querySelector(`.chat-room[data-room="${room}"]`).classList.add('active');
      
      // Update header
      activeChatHeader.textContent = getRoomDisplayName(room);
      
      // Determine collection path based on room type
      let collectionPath;
      if (room === 'rwanda') {
        collectionPath = `rwanda/${currentUserData.class.toLowerCase().replace(' ', '')}/messages`;
      } else if (room.startsWith('senior')) {
        collectionPath = `classes/${room}/messages`;
      } else {
        // District room
        collectionPath = `districts/${room}/${currentUserData.class.toLowerCase().replace(' ', '')}/messages`;
      }
      
      // Set up real-time listener
      const q = query(
        collection(db, collectionPath),
        orderBy('timestamp', 'asc')
      );
      
      onSnapshot(q, (snapshot) => {
        snapshot.docChanges().forEach((change) => {
          if (change.type === 'added') {
            displayMessage(change.doc.data());
            
            // Play sound and show notification if message is from another user
            if (change.doc.data().uid !== currentUser.uid) {
              playMessageSound();
              showNotification(`New message from ${change.doc.data().username}`);
            }
          }
        });
      });
    }

    // Display a message in the chat
    function displayMessage(messageData) {
      const messageDiv = document.createElement('div');
      messageDiv.classList.add('message');
      messageDiv.classList.add(messageData.uid === currentUser.uid ? 'sent' : 'received');
      
      // Check for inappropriate content
      const hasInappropriateContent = inappropriateWords.some(word => 
        messageData.text.toLowerCase().includes(word)
      );
      
      if (hasInappropriateContent) {
        messageDiv.classList.add('violation');
      }
      
      messageDiv.innerHTML = `
        <div class="message-username">@${messageData.username}</div>
        <div class="message-content">${messageData.text}</div>
        <div class="message-time">${formatTime(messageData.timestamp?.toDate())}</div>
        <div class="message-actions">
          ${messageData.uid === currentUser.uid ? `
            <button class="message-action" title="Edit" onclick="editMessage('${messageData.id}')">‚úèÔ∏è</button>
            <button class="message-action" title="Delete" onclick="deleteMessage('${messageData.id}')">üóëÔ∏è</button>
          ` : `
            <button class="message-action" title="Reply" onclick="replyToMessage('${messageData.username}')">‚Ü©</button>
            <button class="message-action" title="Report" onclick="reportMessage('${messageData.id}')">‚ö†Ô∏è</button>
          `}
        </div>
      `;
      
      messagesContainer.appendChild(messageDiv);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    // Send a new message
    async function sendMessage() {
      const text = messageInput.value.trim();
      if (!text) return;
      
      // Determine collection path based on current room
      let collectionPath;
      if (currentChatRoom === 'rwanda') {
        collectionPath = `rwanda/${currentUserData.class.toLowerCase().replace(' ', '')}/messages`;
      } else if (currentChatRoom.startsWith('senior')) {
        collectionPath = `classes/${currentChatRoom}/messages`;
      } else {
        // District room
        collectionPath = `districts/${currentChatRoom}/${currentUserData.class.toLowerCase().replace(' ', '')}/messages`;
      }
      
      try {
        await addDoc(collection(db, collectionPath), {
          text: text,
          uid: currentUser.uid,
          username: currentUserData.username,
          timestamp: serverTimestamp(),
          hasImage: false
        });
        
        messageInput.value = '';
        messageInput.style.height = 'auto';
      } catch (error) {
        console.error('Error sending message:', error);
        alert('Failed to send message. Please try again.');
      }
    }

    // Upload image using ImgBB API
    async function uploadImage(file) {
      const formData = new FormData();
      formData.append('image', file);
      
      try {
        const response = await fetch('https://api.imgbb.com/1/upload?key=6d94d15b3d7c33ecc4c1ebdfa5e69a92', {
          method: 'POST',
          body: formData
        });
        
        const data = await response.json();
        return data.data.url;
      } catch (error) {
        console.error('Error uploading image:', error);
        alert('Failed to upload image. Please try again.');
        return null;
      }
    }

    // Format timestamp
    function formatTime(date) {
      if (!date) return 'Just now';
      
      const now = new Date();
      const diff = now - date;
      
      if (diff < 60000) return 'Just now';
      if (diff < 3600000) return `${Math.floor(diff / 60000)} min ago`;
      
      return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }

    // Play message sound
    function playMessageSound() {
      messageSound.currentTime = 0;
      messageSound.play().catch(e => console.log('Audio play failed:', e));
    }

    // Show notification
    function showNotification(text) {
      notification.textContent = text;
      notification.style.display = 'block';
      
      setTimeout(() => {
        notification.style.display = 'none';
      }, 3000);
    }

    // Get display name for a room
    function getRoomDisplayName(room) {
      switch(room) {
        case 'rwanda': return 'Rwanda Public Chat';
        case 'senior1': return 'Senior 1 Chat';
        case 'senior2': return 'Senior 2 Chat';
        case 'senior3': return 'Senior 3 Chat';
        case 'senior4': return 'Senior 4 Chat';
        case 'senior5': return 'Senior 5 Chat';
        case 'senior6': return 'Senior 6 Chat';
        default: return `${room.charAt(0).toUpperCase() + room.slice(1)} District Chat`;
      }
    }

    // Set up event listeners
    sendButton.addEventListener('click', sendMessage);
    
    messageInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
      
      // Auto-resize textarea
      setTimeout(() => {
        messageInput.style.height = 'auto';
        messageInput.style.height = Math.min(messageInput.scrollHeight, 120) + 'px';
      }, 0);
    });
    
    uploadTrigger.addEventListener('click', () => {
      imageUpload.click();
    });
    
    imageUpload.addEventListener('change', async (e) => {
      if (e.target.files.length > 0) {
        const imageUrl = await uploadImage(e.target.files[0]);
        if (imageUrl) {
          messageInput.value = messageInput.value + ` [Image: ${imageUrl}] `;
        }
      }
    });
    
    // Chat room selection
    document.querySelectorAll('.chat-room').forEach(room => {
      room.addEventListener('click', () => {
        if (room.style.cursor === 'not-allowed') return;
        
        currentChatRoom = room.dataset.room;
        loadMessages(currentChatRoom);
        
        // Update system display
        if (currentChatRoom === 'rwanda') {
          currentSystemText.textContent = 'In Rwanda';
          systemIcon.textContent = 'üåê';
        } else if (currentChatRoom.startsWith('senior')) {
          currentSystemText.textContent = `In ${currentChatRoom.charAt(0).toUpperCase() + currentChatRoom.slice(1)}`;
          systemIcon.textContent = 'üéì';
        } else {
          currentSystemText.textContent = `In ${currentChatRoom.charAt(0).toUpperCase() + currentChatRoom.slice(1)}`;
          systemIcon.textContent = 'üó∫Ô∏è';
        }
      });
    });

    // Set up Firebase Cloud Messaging
    onMessage(messaging, (payload) => {
      console.log('Message received:', payload);
      showNotification(payload.notification.title);
      playMessageSound();
    });

    // Global functions for message actions
    window.editMessage = async (messageId) => {
      const newText = prompt('Edit your message:');
      if (newText !== null) {
        // Implementation for editing message
        console.log('Edit message:', messageId, newText);
      }
    };

    window.deleteMessage = async (messageId) => {
      if (confirm('Are you sure you want to delete this message?')) {
        // Implementation for deleting message
        console.log('Delete message:', messageId);
      }
    };

    window.replyToMessage = (username) => {
      messageInput.value = `@${username} `;
      messageInput.focus();
    };

    window.reportMessage = async (messageId) => {
      if (confirm('Report this message as inappropriate?')) {
        // Implementation for reporting message
        console.log('Report message:', messageId);
        alert('Thank you for your report. We will review this message.');
      }
    };

    window.openPage = (page) => {
      window.location.href = page;
    };
  </script>
</body>
</html>
